<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<title>Drum Metronome Exercise Timer — Offline</title>
<style>
  :root{
    --neutral:#ffdc00; /* yellow */
    --break:#48ade0;   /* blue */
    --active:#f578ff;  /* pink */
    --paused:#bbbbbb;  /* grey */
    --text:#000;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: 'Courier New', monospace;
    background: var(--neutral);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-y:auto;
  }
  body.break { background: var(--break); }
  body.active { background: var(--active); }
  body.paused { background: var(--paused); }

  /* Full screen progress tint that grows left->right (25% tint) */
  #progress-bg{
    pointer-events:none;
    position:fixed; inset:0; z-index:-1;
    background: linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 0%);
    background-size:0% 100%;
    background-repeat:no-repeat;
    background-position:left center;
  }

  .app{max-width:900px;margin:0px auto;padding:60px 18px 18px 18px;}
  h1{font-family:'Courier New',monospace;font-weight:bold;text-align:center;font-size:12px;margin:40px 0 12px 0;letter-spacing:1px;}

  .big-box{border:none;padding:12px;border-radius:8px;text-align:center;margin-bottom:12px;}
  #currentExercise{
	  font-family: "Press Start 2P", system-ui, 'Courier New', monospace;
	  text-transform: uppercase;
	  padding-bottom: 8px;
	  font-size: 60px;
	  font-weight: 800;
	  height:150px;
	  color:#FFF;}
	
  #currentHand{ 
	  font-family: "Press Start 2P", system-ui, 'Courier New', monospace;
	  text-transform: uppercase;
	  font-size:18px;
	  color:black;
	  display:inline-block;
	  height:30px;
	  min-width:100px;}
  #monkeyBox{
    /* FIX: monkey centred as a box, text left-aligned inside */
    border:none;background:none;
    font-weight:bold;white-space:pre;text-align:left;
    font-family:"Press Start 2P", system-ui, 'Courier New',monospace;font-size:22px;line-height:1;
    min-width:10px;display:block; width:max-content; max-width:100%;
    margin:10px auto; /* centers the box */
  }
  #beatIndicatorBox{margin-top:10px;}
  .beat-dot{width:18px;height:18px;border-radius:50%;display:inline-block;margin:0 6px;border:8px solid #FFF;background:transparent;}
  .beat-dot.active{background:#e925f4;}
  #timerSmall{font-family:"Press Start 2P", system-ui, 'Courier New', monospace;font-size:16px;margin-top:8px;color:#000;}
  .controls{display:flex;gap:12px;justify-content:center;margin:10px 0 18px 0;}
  .controls button{font-family:"Press Start 2P", system-ui, 'Courier New', monospace;font-size:20px;font-weight:bold;padding:11px 16px 10px 19px;border-radius:6px;border:none;background:#000;cursor:pointer; text-transform: uppercase;color:#FFF;}
  .controls button:hover{transition: 0.1s; background:#fff; color:#000;}
  .controls button[disabled]{opacity:.6;cursor:not-allowed;font-family:'Courier New', monospace;}
  .bpm{display:flex;gap:8px;justify-content:center;align-items:center;margin-bottom:14px;}
  #bpmInput{width:80px;font-family:'Courier New', monospace;font-weight:bold;font-size:20px;padding:8px 8px 8px 20px;border:none;border-radius:6px;text-align:center;}

  .list-box{border:none;padding:10px;border-radius:8px;background:none;margin-bottom:12px;}
  #intervalList{list-style:none;margin:0;padding:0;}
  .interval-row{
    display:grid;
    grid-template-columns: 48px 1fr auto auto; /* arrows | desc | editors | delete */
    gap:10px; align-items:center;
    padding:8px;border-bottom:1px solid #000;
  }
  .interval-row:first-child{border-top:6px solid #000;padding-top:16px;margin-top:40px;}
  .interval-row:last-child{border-bottom:1px solid #000;}
  .interval-row.active{border-color:#000000;color:#000000;font-weight:bold;text-decoration:underline;}
.interval-row.completed { opacity:0.7; text-decoration:line-through;}
.interval-row.upcoming  { font-weight:bold;font-style:italic; }


  .arrows{display:flex;flex-direction:column;gap:6px;}
  .arrowBtn{width:36px;height:28px;border:none;background:#fff;cursor:pointer;border-radius:6px;font-family:"Press Start 2P", system-ui, 'Courier New', monospace;font-weight:bold;}
  .arrowBtn:hover{transition: 0.1s; background:#000; color:#FFF;}
  .arrowBtn[disabled]{opacity:.0;cursor:not-allowed;}
  .desc-static{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .desc-input{
    width:100%;max-width:100%;padding:10px;background:none;border:none;border-radius:6px;font-size:16px;font-family:'Courier New', monospace;
  }
  .edit-pack{display:flex;gap:8px;align-items:center;justify-content:flex-end;}
  .edit-pack input[type="number"]{
    width:140px;padding:6px;border:none;border-radius:6px;font-family:'Courier New', monospace;
    /* FIX: spacing to the right of seconds box */
    margin-right:8px;
  }
  .edit-pack select{padding:6px;border:none;border-radius:6px;font-family:'Courier New', monospace;}
  .tags{display:flex;gap:10px;align-items:center;justify-content:flex-end;}
  .tag{padding:6px;border:none;border-radius:4px;background:none;font-size:14px;width:140px;margin:6px;}
  .deleteBtn{background:#000;border:none;padding:9px 8px 8px 10px;border-radius:6px;cursor:pointer;font-weight:bold;font-family:"Press Start 2P", system-ui, 'Courier New', monospace;color:#fff;}
  .deleteBtn:hover{transition: 0.1s; background:#fff; color:#000;}
  .deleteBtn[disabled]{opacity:.0;cursor:not-allowed;}

  #addForm{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap;}
  #addForm input[type="text"]{margin-left:65px;width:400px;padding:10px;border:none;border-radius:6px;font-family:'Courier New', monospace;font-size:16px;color:#000;}
  #addForm input[type="number"]{width:90px;padding:10px;border:none;border-radius:6px;font-family:'Courier New', monospace;font-size:16px;color:#000;}
  #addForm select{padding:10px;border:none;border-radius:10px;font-family:'Courier New', monospace;font-size:16px;color:#000;}
  #addForm button{background:black;border:none;padding:13px 12px 12px 15px;border-radius:6px;cursor:pointer;font-weight:bold;color:white;font-family:"Press Start 2P", system-ui, 'Courier New', monospace;color:#fff;font size:16px; text-transform: uppercase;}
  #addForm button:hover{transition: 0.1s; background:#fff; color:#000;}
	
  #advancedToggle{display:block;margin:12px 0px 12px 0px;width:100%;text-align:center;padding:0px;border:none;background:none;cursor:pointer;border-radius:8px;font-weight:bold;font-family:'Courier New', monospace;font-size:16px;}
  #advanced{text-align:center;display:none;border-top:1px solid #000;padding:8px;background:none;}
  #advanced label{text-align:center;display:block;margin:6px 0;font-size:13px;font-family:'Courier New', monospace;}
  .hint{font-size:12px;color:#000;margin-top:6px;text-align:center;}

	
 /* --- PHONE SIZE UI --- */
@media (max-width:640px){
  /* --- Editable state (yellow background) --- */
  
  /* Overall form layout fix */
  #addForm { 
    display: flex;
    flex-wrap: wrap; 
    align-items: center;
    gap: 8px; /* Consistent spacing between elements */
  }
  
  /* The description input now takes the full width and forces a new line */
  #addForm input[type="text"] {
    width: 100%;
    margin-left:0; 
  }
  
  /* The seconds and hand selection are now on the same line */
  #addForm input[type="number"], 
  #addForm select, 
  #addForm button { 
    /* Allows elements to shrink and grow on the line */
    flex: 1 1 auto; 
    width: auto; 
    margin-left:0; 
  }

  /* Exercise list row fix: Applies to the row when editable */
  .interval-row:has(.desc-input){
    display: grid;
    /* Defines a 2-row, 3-column layout */
    grid-template-columns: 48px 1fr auto;
    grid-template-rows: auto auto; 
    align-items: center;
    gap: 0;
  }
  
  /* The description input now spans the entire first row */
  .desc-input {
    width: 100%;
    grid-column: 1 / 4;
    grid-row: 1;
  }

  /* The arrow is explicitly placed on the second row, first column */
  .arrows { 
    margin-bottom: 5px; 
    grid-column: 1;
    grid-row: 2;
  }
  
  /* The input/select container is placed on the second row, second column */
  .edit-pack {
    grid-column: 2;
    grid-row: 2;
    justify-content: flex-start;
    margin-top: 5px;
    flex-wrap: wrap; 
    width: 100%;
  }

  /* The X button is placed on the second row, third column */
  .deleteBtn {
    font-size: 14px;
    padding: 7px 6px 6px 8px;
    margin-left: 8px; 
    grid-column: 3;
    grid-row: 2;
    justify-self: end;
  }

  /* --- Static state (pink background) --- */

  .interval-row:has(.desc-static) {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .desc-static {
    font-size: 20px;
    word-break: break-word;
    white-space: normal;
    margin-bottom: 8px;
    text-decoration: underline;
  }
  .tags {
    justify-content: flex-start;
    flex-wrap: wrap;
    gap: 10px;
  }
  .tags .tag {
    font-size: 16px;
    width: auto;
    max-width: none;
    margin: 0;
  }

  /* General Layout */
  #currentExercise { font-size: 28px; height:auto; padding-bottom:4px; }
  #currentHand { font-size:14px; min-width:unset; height:auto; }
  h1 { font-size:10px; margin:20px 0 8px; }
}
	
}
</style>
</head>
<body>
  <div id="progress-bg"></div>

  <div class="app" role="main">
    <h1>&nbsp;</h1>

    <div class="big-box" id="currentBox">
      <div id="currentExercise">Ready</div>
      <div id="currentHand">Break time</div>
      <div id="timerSmall">00:00</div>
    </div>

    <div id="monkeyBox" class="big-box" aria-hidden="true"></div>
    <div id="beatIndicatorBox" class="big-box" style="padding:10px 12px;">
      <div id="beatDots" aria-hidden="true"></div>
    </div>

    <div class="controls">
      <button id="startPauseBtn" aria-pressed="false">Start</button>
      <button id="resetBtn">Reset</button>
    </div>

    <div class="bpm">
<input id="bpmInput" type="number" min="40" max="500" value="150" />
    </div>

    <div class="list-box" role="region" aria-label="Intervals">
      <ul id="intervalList"></ul>

      <form id="addForm" onsubmit="return false;">
        <input id="addDesc" type="text" placeholder="Description" required />
        <input id="addSeconds" type="number" placeholder="Seconds" min="1" max="120" required />
        <select id="addHand">
          <option value="alternate">Alternate L/R</option>
          <option value="both">Both Hands</option>
        </select>
        <button id="addBtn">Add</button>
      </form>
</div>

    <div id="advancedToggle">Advanced Settings ▾</div>
    <div id="advanced">
      <label>Break length (bars, 0–4)
        <input id="breakBars" type="number" min="0" max="4" value="2" />
      </label>
      <label><input id="metronomeToggle" type="checkbox" checked /> Enable metronome</label>
      <label>Accent style
        <select id="accentStyle">
          <option value="quarter">Quarter notes (4)</option>
          <option value="triplet">Triplets (3)</option>
          <option value="none">None</option>
        </select>
      </label>
    </div>
  </div>

<script>
(function(){
  /* ===================== Defaults ===================== */
  const DEFAULT_INTERVALS = [
    {description:"Thumbs Down Consistent", seconds:60, handMode:"alternate"},
    {description:"Thumbs Down Accents", seconds:60, handMode:"alternate"},
    {description:"Hands Up Triplets", seconds:60, handMode:"alternate"},
    {description:"Hands Up 32nd Notes", seconds:60, handMode:"alternate"},
    {description:"Stick Hold Fingers", seconds:60, handMode:"alternate"},
    {description:"Stick Hold Palms", seconds:60, handMode:"alternate"},
    {description:"Cigar Hold Grip", seconds:60, handMode:"both"},
    {description:"Little Sticks Grip", seconds:60, handMode:"both"},
    {description:"Standard Ol' Grip", seconds:60, handMode:"both"}
  ];

  /* ===================== DOM refs ===================== */
  const body = document.body;
  const bpmInput = document.getElementById('bpmInput');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const intervalList = document.getElementById('intervalList');
  const addForm = document.getElementById('addForm');
  const addDesc = document.getElementById('addDesc');
  const addSeconds = document.getElementById('addSeconds');
  const addHand = document.getElementById('addHand');
  const monkeyBox = document.getElementById('monkeyBox');
  const beatDots = document.getElementById('beatDots');
  const currentExercise = document.getElementById('currentExercise');
  const currentHand = document.getElementById('currentHand');
  const timerSmall = document.getElementById('timerSmall');
  const progressBg = document.getElementById('progress-bg');
  const advancedToggle = document.getElementById('advancedToggle');
  const advanced = document.getElementById('advanced');
  const breakBarsInput = document.getElementById('breakBars');
  const metronomeToggle = document.getElementById('metronomeToggle');
  const accentStyleSel = document.getElementById('accentStyle');

  /* ===================== Audio ===================== */
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  const scheduleAheadTime = 0.1; // seconds
  const lookahead = 25; // ms
  let schedulerId = null;
  let nextNoteTime = 0;

  /* ===================== State ===================== */
  let bpm = parseInt(bpmInput.value,10) || 150;

  function beatsPerBarCurrent(style=accentStyleSel.value){
    if(style === 'triplet') return 3;
    return 4; // quarter or none
  }

  let breakBars = parseInt(breakBarsInput.value,10) || 2;
  let metronomeOn = metronomeToggle.checked;

  let sequence = [];
  let seqPos = 0;
  let beatInPhase = 0;
  let phaseStartMs = 0;
  let running = false;
  let paused = false;
	let animId = null;
  let pausedElapsedMs = 0;
  let monkeyPose = false;

  let intervals = JSON.parse(JSON.stringify(DEFAULT_INTERVALS));

  /* ===================== Time helpers ===================== */
  function secondsToBeats(seconds, bpmLocal){ return Math.max(1, Math.round(seconds * (bpmLocal/60))); }
  function beatsToBars(beats, beatsPerBar){ return Math.max(1, Math.round(beats / beatsPerBar)); }
  function barsToBeats(bars, beatsPerBar){ return bars * beatsPerBar; }
  function beatDuration(bpmLocal){ return 60 / bpmLocal; }

  /* ===================== Build sequence ===================== */
  function buildSequenceFromIntervals(){
    const seq = [];
    const localBpm = bpm;

    const bpb = beatsPerBarCurrent();
    const breakBeats = Math.max(0, (parseInt(breakBarsInput.value,10)||0)) * bpb;

    if(breakBeats > 0) seq.push({type:'break', idx:-1, hand:'both', beats: breakBeats});

    for(let i=0;i<intervals.length;i++){
      const it = intervals[i];
      const beatsRounded = secondsToBeats(it.seconds, localBpm);
      const bars = beatsToBars(beatsRounded, bpb);
      const actualBeats = barsToBeats(bars, bpb);

      if(it.handMode === 'alternate'){
        seq.push({type:'interval', idx:i, hand:'right', beats: actualBeats});
        if(breakBeats>0) seq.push({type:'break', idx:i, hand:'both', beats: breakBeats});
        seq.push({type:'interval', idx:i, hand:'left', beats: actualBeats});
      } else {
        seq.push({type:'interval', idx:i, hand:'both', beats: actualBeats});
      }
      if(i < intervals.length - 1 && breakBeats>0) seq.push({type:'break', idx:i, hand:'both', beats: breakBeats});
    }
    return seq;
  }

  /* ===================== Clicks ===================== */
  function playClick(atTime, accent=false, breakClick=false){
    if(!metronomeOn) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.type = 'square';
    if(breakClick){
      o.frequency.setValueAtTime(420, atTime);
      g.gain.setValueAtTime(0.06, atTime);
    } else if(accent){
      o.frequency.setValueAtTime(1000, atTime);
      g.gain.setValueAtTime(0.22, atTime);
    } else {
      o.frequency.setValueAtTime(640, atTime);
      g.gain.setValueAtTime(0.12, atTime);
    }
    g.gain.exponentialRampToValueAtTime(0.001, atTime + 0.08);
    o.start(atTime); o.stop(atTime + 0.09);
  }

  /* ===================== Scheduler ===================== */
  function startScheduler(){
    if(schedulerId) return;
    nextNoteTime = audioCtx.currentTime + 0.05;
    schedulerId = setInterval(schedulerLoop, lookahead);
  }
  function stopScheduler(){ if(schedulerId){ clearInterval(schedulerId); schedulerId = null; } }

  function schedulerLoop(){
    const now = audioCtx.currentTime;
    while(nextNoteTime < now + scheduleAheadTime){
      scheduleTick(nextNoteTime);
      nextNoteTime += beatDuration(bpm);
    }
  }

  function scheduleTick(atTime){
    const cur = sequence[seqPos];
    if(!cur){ stop(); return; }

    let accent = false;
    if(cur.type !== 'break'){
      const style = accentStyleSel.value;
      if(style === 'quarter') accent = (beatInPhase % 4 === 0);
      else if(style === 'triplet') accent = (beatInPhase % 3 === 0);
    }
    const isBreakClick = (cur.type === 'break');
    playClick(atTime, accent, isBreakClick);

    const msUntil = Math.max(0, (atTime - audioCtx.currentTime) * 1000);
    setTimeout(onBeatArrival, Math.round(msUntil));
  }

  /* ===================== Visual beat arrival ===================== */
  function onBeatArrival(){
    if(paused || !running) return;
    const cur = sequence[seqPos];
    if(!cur) return;

    renderBeatDotsLive(cur);

    monkeyPose = 1 - monkeyPose;
    renderMonkey(cur?.type);

    beatInPhase++;
    if(beatInPhase >= cur.beats){
      seqPos++;
      beatInPhase = 0;
      phaseStartMs = performance.now();
      if(seqPos >= sequence.length){ stop(); return; }
      renderBeatDotsBlank();
      updatePhaseUI(true);
    }
  }

// --- random break phrases ---
let breakPhrases = [
  "Shake your blood",
  "You're a maniac",
  "Keep hitting stuff",
  "Burning is fine",
  "Pain is expected",
  "Rest is weakness",
  "Wiggle the mouse"
];

let shuffledBreaks = [];
let firstBreakShown = false;

function getNextBreakPhrase() {
  if (!firstBreakShown) {
    firstBreakShown = true;
    return "Let's Make Milkshake";
  }

  if (shuffledBreaks.length === 0) {
    shuffledBreaks = [...breakPhrases].sort(() => Math.random() - 0.5);
  }
  return shuffledBreaks.pop();
}

// --- UI ---
function updatePhaseUI(fromPhaseChange=false){
  const cur = sequence[seqPos];
  if(!cur){
    currentExercise.textContent = "Done!";
    currentHand.textContent = "Break Time";
    body.className = '';
    timerSmall.textContent = "00:00";
    renderIntervals();
    return;
  }

  if(cur.type === 'break'){
    const phrase = getNextBreakPhrase();
    currentExercise.textContent = phrase;
    currentHand.textContent = "Break Time";
    body.className = 'break';
  } else {
    const it = intervals[cur.idx];
    currentExercise.textContent = it.description;
    if(cur.hand === 'right') currentHand.textContent = "  RIGHT HAND";
    else if(cur.hand === 'left') currentHand.textContent = "LEFT HAND  ";
    else currentHand.textContent = "BOTH HANDS";
    body.className = 'active';
  }

  if(fromPhaseChange){
    updatePhaseTimerAndProgress(true);
  } else {
    updatePhaseTimerAndProgress(false);
  }
  renderIntervals();
}

  function updatePhaseTimerAndProgress(reset=false){
    const cur = sequence[seqPos];
    if(!cur){
      timerSmall.textContent = "00:00";
      progressBg.style.background = 'linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 0%)';
      return;
    }
    const phaseDurSec = cur.beats * beatDuration(bpm);
    if(reset) phaseStartMs = performance.now();
    const elapsedMs = Math.max(0, performance.now() - phaseStartMs);
    const elapsedSec = elapsedMs / 1000;
    const remaining = Math.max(0, phaseDurSec - elapsedSec);
    const mm = Math.floor(remaining/60), ss = Math.floor(remaining%60);
    timerSmall.textContent = (mm<10?'0'+mm:mm) + ':' + (ss<10?'0'+ss:ss);

    const pct = Math.min(1, elapsedSec / phaseDurSec) * 100;
    if(cur.type === 'break'){
      progressBg.style.background = `linear-gradient(to right, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.25) ${pct}%, rgba(0,0,0,0) ${pct}%)`;
    } else {
      progressBg.style.background = `linear-gradient(to right, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.25) ${pct}%, rgba(0,0,0,0) ${pct}%)`;
    }
  }

  /* ===================== Beat dots ===================== */
  function renderBeatDotsBlank(){
    const style = accentStyleSel.value;
    const count = (style === 'triplet') ? 3 : 4;
    let html = '';
    for(let i=0; i<count; i++){
      html += '<div class="beat-dot"></div>';
    }
    beatDots.innerHTML = html;
  }

  function renderBeatDotsLive(cur){
    const style = accentStyleSel.value;
    const count = (style === 'triplet') ? 3 : 4;

    if(beatDots.children.length !== count){
      renderBeatDotsBlank();
    }
    if(cur.type === 'break'){
      for(let i=0;i<count;i++){
        beatDots.children[i].classList.remove('active');
      }
      return;
    }
    const activeIndex = beatInPhase % count;
    for(let i=0;i<count;i++){
      beatDots.children[i].classList.toggle('active', i===activeIndex);
    }
  }

function renderMonkey(curPhaseType){
  const exercise1 = `
     /~_
    { Oo
o  _ (-^)_
 \\/~[. .]~\\
     \\…/   \\
    _| |_   o`;

  const exercise2 = `
     _~\\
     oO }
   _(^-) _  o
  /~[. .]~\\/
 /   \\…/
o   _| |_`;

  const pause1 = `
      _~
     {oO}
o  _(-^-)_  o 
 \\/~[. .]~\\/
     \\…/
    _| |_`;

  const pause2 = `

      _~
     {oO}
 o _(-^-)_ o 
 |/~[.….]~\\|
   _/   \\_`;

  if(curPhaseType === 'break'){
    monkeyBox.textContent = (monkeyPose ? pause2 : pause1);
  } else if(!running || paused){
  monkeyBox.textContent = pause1;
  } else {
    monkeyBox.textContent = (monkeyPose ? exercise2 : exercise1);
  }
  if(curPhaseType === 'neutral'){
    monkeyBox.textContent =  `
      _~
     {oO}
o  _(-^-)_  o 
 \\/~[. .]~\\/
     \\…/
    _| |_`;
  }
}

  /* ===================== Interval list ===================== */
  function buildEditableRow(it, idx, isActive){
    const li = document.createElement('li'); li.className = 'interval-row' + (isActive ? ' active' : '');

    const arrows = document.createElement('div'); arrows.className='arrows';
    const up = document.createElement('button'); up.className='arrowBtn'; up.textContent='▲';
    up.onclick = ()=>{ moveInterval(idx,'up'); renderIntervals(); };
    arrows.appendChild(up);

    const descInput = document.createElement('input'); descInput.className='desc-input';
    descInput.type='text'; descInput.value=it.description; descInput.title='Description';
    descInput.oninput = (e)=>{ intervals[idx].description = e.target.value; };

    const editors = document.createElement('div'); editors.className='edit-pack';
    const secInput = document.createElement('input');
    secInput.type='number'; secInput.min=1; secInput.value = it.seconds; secInput.title='Seconds';
    secInput.oninput = (e)=>{ const v = parseInt(e.target.value||0,10); if(v>0) intervals[idx].seconds = v; };
    const handSel = document.createElement('select');
    const o1 = document.createElement('option'); o1.value='alternate'; o1.text='Alternate L/R';
    const o2 = document.createElement('option'); o2.value='both'; o2.text='Both Hands';
    handSel.appendChild(o1); handSel.appendChild(o2);
    handSel.value = it.handMode; handSel.onchange = (e)=>{ intervals[idx].handMode = e.target.value; };
    editors.appendChild(secInput); editors.appendChild(handSel);

    const del = document.createElement('button'); del.className='deleteBtn'; del.textContent='X';
    del.onclick = ()=>{ intervals.splice(idx,1); renderIntervals(); };

    li.appendChild(arrows);
    li.appendChild(descInput);
    li.appendChild(editors);
    li.appendChild(del);
    return li;
  }

  function buildStaticRow(it, idx, isActive){
    const li = document.createElement('li'); li.className = 'interval-row' + (isActive ? ' active' : '');

    const arrows = document.createElement('div'); arrows.className='arrows';
    const up = document.createElement('button'); up.className='arrowBtn'; up.textContent='▲'; up.disabled = true;
    arrows.appendChild(up);

    const desc = document.createElement('div'); desc.className='desc-static'; desc.textContent = it.description;

    const tags = document.createElement('div'); tags.className='tags';
    const s = document.createElement('span'); s.className='tag'; s.textContent = it.seconds + 's';
    const h = document.createElement('span'); h.className='tag'; h.textContent = (it.handMode==='alternate'?'Alternate L/R':'Both Hands');
    tags.appendChild(s); tags.appendChild(h);

    const del = document.createElement('button'); del.className='deleteBtn'; del.textContent='X'; del.disabled = true;

    li.appendChild(arrows);
    li.appendChild(desc);
    li.appendChild(tags);
    li.appendChild(del);
    return li;
  }

function renderIntervals() {
  intervalList.innerHTML = '';
  const cur = sequence[seqPos] || null;
  const editable = (!running || paused);

  intervals.forEach((it, idx) => {
    const isActive = !!(cur && cur.type === 'interval' && cur.idx === idx);
    const isCompleted = seqPos > 0 && sequence.length > 0 && sequence
  .filter(s => s.type === 'interval' && s.idx === idx)
  .every(s => sequence.indexOf(s) < seqPos);
    const isUpcoming = cur && cur.type === 'break' &&
      sequence[seqPos + 1] &&
      sequence[seqPos + 1].type === 'interval' &&
      sequence[seqPos + 1].idx === idx;

    const row = editable
      ? buildEditableRow(it, idx, isActive)
      : buildStaticRow(it, idx, isActive);

    if (isActive) row.classList.add('active');
    if (isCompleted) row.classList.add('completed');
    if (isUpcoming) row.classList.add('upcoming');

    intervalList.appendChild(row);
  });
}


  function moveInterval(index, dir){
    if(dir==='up' && index>0){ [intervals[index-1], intervals[index]] = [intervals[index], intervals[index-1]]; }
    else if(dir==='down' && index < intervals.length-1){ [intervals[index+1], intervals[index]] = [intervals[index], intervals[index+1]]; }
  }

  function toggleEditableInputs(isEditable) {
    // Hide or show the add form and advanced settings
    addForm.style.display = isEditable ? 'flex' : 'none';
    advancedToggle.style.display = isEditable ? 'block' : 'none';
    advanced.style.display = isEditable ? 'none' : 'none'; // Keep it hidden by default

    // Disable or enable the BPM input
    bpmInput.disabled = !isEditable;
    // Set the appropriate cursor for the BPM input
    bpmInput.style.cursor = isEditable ? 'auto' : 'not-allowed';
  }

  /* ===================== Run control ===================== */
  function freshStart(){
    bpm = Math.max(40, Math.min(500, parseInt(bpmInput.value)||150));
    breakBars = Math.max(0, Math.min(4, parseInt(breakBarsInput.value)||2));
    metronomeOn = metronomeToggle.checked;

    sequence = buildSequenceFromIntervals();
    seqPos = 0;
    beatInPhase = 0;
    phaseStartMs = performance.now();
    monkeyPose = 0;
    pausedElapsedMs = 0;

    if(audioCtx.state !== 'running') audioCtx.resume();
    nextNoteTime = audioCtx.currentTime + 0.05;

    startScheduler();
    running = true; paused = false;
    toggleEditableInputs(false);

    renderBeatDotsBlank();
    updatePhaseUI(true);
    renderMonkey('neutral');
    renderIntervals();
    startPauseBtn.textContent = 'Pause'; startPauseBtn.setAttribute('aria-pressed','true');

    animId = requestAnimationFrame(visualLoop);
  }

  function pause(){
    if(!running || paused) return;
    paused = true;

    pausedElapsedMs = performance.now() - phaseStartMs;

    stopScheduler();
    if(audioCtx.state === 'running') audioCtx.suspend();

    startPauseBtn.textContent = 'Start'; startPauseBtn.setAttribute('aria-pressed','false');
    body.className = 'paused';
    toggleEditableInputs(true);
    renderIntervals();
  }

  function resumeFromPause(){
    if(!running || !paused) return;
    paused = false;

    audioCtx.resume().then(()=>{
      nextNoteTime = audioCtx.currentTime + 0.05;
      startScheduler();

      phaseStartMs = performance.now() - pausedElapsedMs;

      updatePhaseUI();
      startPauseBtn.textContent = 'Pause'; startPauseBtn.setAttribute('aria-pressed','true');
      toggleEditableInputs(false);
      animId = requestAnimationFrame(visualLoop);
    });
  }

  function stop(){
    running = false; paused = false;
    stopScheduler();
    if(audioCtx.state === 'running') audioCtx.suspend();
    seqPos = sequence.length;
    renderIntervals();
    body.className = '';
    timerSmall.textContent = "00:00";
    progressBg.style.background = 'linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 0%)';
    renderBeatDotsBlank();
    currentExercise.textContent = "Done!";
    currentHand.textContent = "";
    startPauseBtn.textContent = 'Start'; startPauseBtn.setAttribute('aria-pressed','false');
    toggleEditableInputs(true);
  }

function reset() {
  stop();
  if (animId) { cancelAnimationFrame(animId); animId = null; }

  running = false;
  paused  = false;
  seqPos = 0;
  beatInPhase = 0;
  monkeyPose = false;
  pausedElapsedMs = 0;
  phaseStartMs = performance.now();

  sequence = buildSequenceFromIntervals();

  renderMonkey('paused');
  body.className = '';
  renderBeatDotsBlank();

  currentExercise.textContent = "Ready to Start?";
  currentHand.textContent = "";
  timerSmall.textContent = "00:00";
  
  toggleEditableInputs(true);
  renderIntervals();

  progressBg.style.background =
    'linear-gradient(to right, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 0%)';

  startPauseBtn.textContent = 'Start';
  startPauseBtn.setAttribute('aria-pressed','false');
}

function visualLoop(){
  if(!running || paused){ 
    animId = null; 
    return; 
  }
  updatePhaseTimerAndProgress(false);
  animId = requestAnimationFrame(visualLoop);
}

  /* ===================== Init ===================== */
  function init(){
    renderMonkey('paused');
    body.className = '';
    sequence = buildSequenceFromIntervals();
    seqPos = 0; beatInPhase = 0; phaseStartMs = performance.now();
    renderBeatDotsBlank();
    currentExercise.textContent = "Ready to Start?"; currentHand.textContent = ""; timerSmall.textContent = "00:00";
    toggleEditableInputs(true);
    renderIntervals();
  }
  init();

  /* ===================== Events ===================== */
  startPauseBtn.addEventListener('click', ()=>{
    if(!running && !paused){ freshStart(); return; }
    if(running && paused){ resumeFromPause(); return; }
    if(running && !paused){ pause(); return; }
  });

  resetBtn.addEventListener('click', reset);

  addForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const d = addDesc.value.trim(), s = parseInt(addSeconds.value,10), h = addHand.value;
    if(!d || !s || s<1){ alert('Enter description and valid seconds'); return; }
    intervals.push({description:d, seconds:s, handMode:h});
    addDesc.value=''; addSeconds.value=''; addHand.value='alternate';
    sequence = buildSequenceFromIntervals(); // Recalculate the sequence
    renderIntervals();
  });

  advancedToggle.addEventListener('click', ()=>{
    advanced.style.display = (advanced.style.display === 'block') ? 'none' : 'block';
    advancedToggle.textContent = advanced.style.display === 'block' ? 'Advanced Settings ▴' : 'Advanced Settings ▾';
  });

  bpmInput.addEventListener('change', ()=>{ 
    bpm = Math.max(40, Math.min(500, parseInt(bpmInput.value)||150));
    // Recalculate sequence, applies on next start/reset
    sequence = buildSequenceFromIntervals();
  });

  breakBarsInput.addEventListener('change', ()=>{
    breakBars = Math.max(0, Math.min(4, parseInt(breakBarsInput.value)||2));
    // Rebuild preview sequence; applies on next start/reset
    sequence = buildSequenceFromIntervals();
    renderIntervals();
  });

  metronomeToggle.addEventListener('change', ()=>{ /* live toggle, no rebuild needed */ });

  // FIX: Switching accent style mid-run won't break audio; we DON'T rebuild sequence automatically.
  // We only update the dots immediately; bar size for breaks/rounding applies on next fresh start/reset.
  accentStyleSel.addEventListener('change', ()=>{
    renderBeatDotsBlank(); // new dot count visible and blank until next beat
    if(!running){ body.className = ''; }
  });

})();
</script>
</body>
</html>